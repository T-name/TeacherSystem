<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>收集</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <link rel="stylesheet" href="/static/css/mdui.css">

    <style>
        body {
            background-color: #FFFFFF;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 56 28' width='56' height='28'%3E%3Cpath fill='%23EDF1F6' fill-opacity='1' d='M56 26v2h-7.75c2.3-1.27 4.94-2 7.75-2zm-26 2a2 2 0 1 0-4 0h-4.09A25.98 25.98 0 0 0 0 16v-2c.67 0 1.34.02 2 .07V14a2 2 0 0 0-2-2v-2a4 4 0 0 1 3.98 3.6 28.09 28.09 0 0 1 2.8-3.86A8 8 0 0 0 0 6V4a9.99 9.99 0 0 1 8.17 4.23c.94-.95 1.96-1.83 3.03-2.63A13.98 13.98 0 0 0 0 0h7.75c2 1.1 3.73 2.63 5.1 4.45 1.12-.72 2.3-1.37 3.53-1.93A20.1 20.1 0 0 0 14.28 0h2.7c.45.56.88 1.14 1.29 1.74 1.3-.48 2.63-.87 4-1.15-.11-.2-.23-.4-.36-.59H26v.07a28.4 28.4 0 0 1 4 0V0h4.09l-.37.59c1.38.28 2.72.67 4.01 1.15.4-.6.84-1.18 1.3-1.74h2.69a20.1 20.1 0 0 0-2.1 2.52c1.23.56 2.41 1.2 3.54 1.93A16.08 16.08 0 0 1 48.25 0H56c-4.58 0-8.65 2.2-11.2 5.6 1.07.8 2.09 1.68 3.03 2.63A9.99 9.99 0 0 1 56 4v2a8 8 0 0 0-6.77 3.74c1.03 1.2 1.97 2.5 2.79 3.86A4 4 0 0 1 56 10v2a2 2 0 0 0-2 2.07 28.4 28.4 0 0 1 2-.07v2c-9.2 0-17.3 4.78-21.91 12H30zM7.75 28H0v-2c2.81 0 5.46.73 7.75 2zM56 20v2c-5.6 0-10.65 2.3-14.28 6h-2.7c4.04-4.89 10.15-8 16.98-8zm-39.03 8h-2.69C10.65 24.3 5.6 22 0 22v-2c6.83 0 12.94 3.11 16.97 8zm15.01-.4a28.09 28.09 0 0 1 2.8-3.86 8 8 0 0 0-13.55 0c1.03 1.2 1.97 2.5 2.79 3.86a4 4 0 0 1 7.96 0zm14.29-11.86c1.3-.48 2.63-.87 4-1.15a25.99 25.99 0 0 0-44.55 0c1.38.28 2.72.67 4.01 1.15a21.98 21.98 0 0 1 36.54 0zm-5.43 2.71c1.13-.72 2.3-1.37 3.54-1.93a19.98 19.98 0 0 0-32.76 0c1.23.56 2.41 1.2 3.54 1.93a15.98 15.98 0 0 1 25.68 0zm-4.67 3.78c.94-.95 1.96-1.83 3.03-2.63a13.98 13.98 0 0 0-22.4 0c1.07.8 2.09 1.68 3.03 2.63a9.99 9.99 0 0 1 16.34 0z'%3E%3C/path%3E%3C/svg%3E");
        }

        .mdui-col-xs-3 .mdui-select {
            float: right;
        }
    </style>
</head>



<body class="mdui-theme-primary-indigo mdui-theme-accent-red mdui-appbar-with-toolbar">

<header class="mdui-appbar mdui-appbar-fixed">
    <div class="mdui-toolbar mdui-color-theme">
        <a class="mdui-btn mdui-btn-icon"><i
                class="mdui-icon material-icons">airplay</i></a>
        <a class="mdui-typo-title" style="margin-left: -10px">作业收集</a>
        <div class="mdui-toolbar-spacer"></div>
        <button class="mdui-btn mdui-ripple" mdui-dialog="{target: '#exampleDialog'}">表单信息</button>
    </div>
    <div class="mdui-progress upload_progress mdui-hidden">
        <div class="mdui-progress-determinate progress" style="width: 0%;"></div>
    </div>
</header>
<div class="mdui-container mdui-m-y-5 mdui-hidden mdui-card" style="max-width: 840px">
    <!-- CONTENT -->
    <div>
        <div class="mdui-tab mdui-tab-centered" mdui-tab>
            <a href="#example3-tab1" class="mdui-ripple doc_null">无文档</a>
            <a href="#example3-tab2" class="mdui-ripple doc">含文档</a>
        </div>
        <div class="mdui-text-center">
            <h3 class="mdui-m-b-1">{$data.title|default=""}</h3>
            <span style="color: #607d8b">{$data.title_info|default=""}</span>
        </div>
    </div>

    <div id="example3-tab1" class="mdui-p-a-2">
        <div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">姓名</label>
                <input class="mdui-textfield-input name_null" type="text"/>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">学号</label>
                <input class="mdui-textfield-input sid_null" oninput = "this.value=this.value.replace(/[^\w_]/g,'');" type="text"/>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">内容</label>
                <div id="editor" class="content_null">

                </div>

            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">备注信息</label>
                <textarea class="mdui-textfield-input note_null" rows="3" maxlength="128"></textarea>
            </div>
        </div>
        <button class="mdui-btn mdui-btn-block mdui-color-theme-accent submit_doc_null">提交</button>
    </div>

    <div id="example3-tab2" class="mdui-p-a-2">
        <div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">姓名</label>
                <input class="mdui-textfield-input name" type="text"/>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">学号</label>
                <input class="mdui-textfield-input sid" oninput = "this.value=this.value.replace(/[^\w_]/g,'');" type="text"/>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">内容</label>
                <input class="mdui-textfield-input file" accept=".7z,.rar,.zip" name="file_name"  type="file"/>
            </div>
            <div class="mdui-textfield">
                <label class="mdui-textfield-label">备注信息</label>
                <textarea class="mdui-textfield-input note" maxlength="128" rows="3"></textarea>
            </div>
            <button class="mdui-btn mdui-btn-block mdui-color-theme-accent  submit_doc">提交</button>
        </div>
    </div>

<!--    表单信息-->
    <div class="mdui-dialog" id="exampleDialog" style="z-index: 10001">
        <div class="mdui-dialog-title">{$data.title|default=""}</div>
        <div class="mdui-dialog-content">
            <p>题目说明：{$data.title_info}</p>
            <p>
                {switch $data.modify}
                {case 1}是否允许再次修改：否{/case}
                {case 2}是否允许再次修改：是{/case}
                {/switch}
            </p>
            <p>
                {switch $data.doc}
                {case 1}是否允许提交文档：不允许{/case}
                {case 2}是否允许提交文档：只允许文档{/case}
                {case 3}是否允许提交文档：都允许{/case}
                {/switch}
            </p>
            <p>谁可以提交:{$data.issend}</p>
            <p class="end_time">截止时间：{$data.end_time}</p>
        </div>
        <div class="mdui-dialog-actions">
            <button class="mdui-btn mdui-ripple" mdui-dialog-confirm>确定</button>
        </div>
    </div>

    <!-- CONTENT -->
</div>

</body>
</html>
<script src="/static/js/jquery-3.4.1.js"></script>
<script src="/static/js/mdui.js"></script>
<script src="/static/wangEditor-3.1.1/release/wangEditor.min.js"></script>

<script>
   // <!--富文本编辑器初始化-->
    var E = window.wangEditor
    var editor = new E('#editor')
    editor.customConfig.menus = [
        'head',  // 标题
        'bold',  // 粗体
        'justify',  // 对齐方式
        'undo',  // 撤销
        'redo'  // 重复
    ]
    editor.create()

    // 页面初始化
    switch ({$data.doc}) {
        case 1:$('.doc').addClass('mdui-hidden');$('.doc_null').addClass('mdui-tab-active');$('.mdui-card').removeClass('mdui-hidden');break;
        case 2:$('.doc_null').addClass('mdui-hidden');$('.doc').addClass('mdui-tab-active');$('.mdui-card').removeClass('mdui-hidden');break;
        case 3:$('.mdui-card').removeClass('mdui-hidden');break;
    }
    var number ='{$data.shareID}';  //编号
    /*** 无文档提交  **/
    $('.submit_doc_null').click(function () {
        var name =$('.name_null').val();
        var sid =$('.sid_null').val();
        var content = editor.txt.html(); //$('.content_null').html();
        console.log(content)
        if(name == "" || sid =="" || content == "<p><br></p>"){
            mdui.snackbar({
                message: "姓名或学号或内容不能为空"
            });
            return;
        }
        var doc =1; //是否有文件 1没有 2有
        // console.log(content);
        var note =$('.note_null').val();
        $.post("/index.php/index/collect/data",{doc:doc,number:number,name:name,sid:sid,content:content,note:note},function (json) {
            //  console.log(json);
            mdui.snackbar({
                message: json.message
            });
        },'json');  //,'json'

    });

    /**
     * 有文档提交
     */
    $('.submit_doc').click(function () {
        //'7z,zip,rar
        var name =$('.name').val();
        var sid =$('.sid').val();
        if(name =="" || sid =="" || $(".file")[0].files[0] == null){
            mdui.snackbar({
                message: '姓名或学号或文件不能为空'
            });
            return;
        }
        var index1=$(".file")[0].files[0]['name'].lastIndexOf(".")+1;
        var index2=$(".file")[0].files[0]['name'].length;
        var type=$(".file")[0].files[0]['name'].substring(index1,index2);
        if(type == "rar" || type == "zip" || type == "7z"){
            if($(".file")[0].files[0]['size'] > 8388608){
                mdui.snackbar({
                    message: '文件不能大于8M'
                });
                return;
            }
            mdui.confirm('确定提交吗？允许提交文件最大为8M 若大于8M则无法提交', '确定提交',
                function(){
                    $('.upload_progress').removeClass('mdui-hidden');
                    var doc =2; //是否有文件 1没有 2有
                    var name =$('.name').val();
                    var sid =$('.sid').val();
                    var note =$('.note').val();
                    var formData = new FormData();
                    formData.append('doc',doc);
                    formData.append('number',number);
                    formData.append('name',name);
                    formData.append('sid',sid);
                    formData.append("file",$(".file")[0].files[0]);  //文件
                    formData.append('note',note);
                    $.ajax({
                        url:'/index.php/index/collect/data', /*接口域名地址*/
                        dataType:"json",
                        type:'post',
                        async:true,  //设置异步才能成功调用myXhr.upload.addEventListener('progress',function(e){}),progress的回掉函数
                        data: formData,
                        contentType: false,
                        processData: false,
                        xhr:function(){
                            myXhr = $.ajaxSettings.xhr();
                            if(myXhr.upload){ // 检查上传属性是否存在
                                myXhr.upload.addEventListener('progress',function(e){
                                    var loaded = e.loaded;                  //已经上传大小情况
                                    var total = e.total;                      //附件总大小
                                    var percent = Math.floor(100*loaded/total)+"%";     //已经上传的百分比
                                    $('.progress').css("width",percent);
                                    if(percent == "100%"){
                                        $('.upload_progress').addClass('mdui-hidden');
                                        $('.progress').css("width",0+'%');
                                    }
                                }, false); // 用于处理上传进度
                            }
                            return myXhr;
                        },
                        success:function(json){
                            //  console.log(json);
                            mdui.snackbar({
                                message: json.message
                            });
                        },
                        error:function (xhr) {
                            $('.upload_progress').addClass('mdui-hidden');
                            $('.progress').css("width",0+'%');
                            mdui.snackbar({
                                message: "数据未提交成功 请检查文件是否过大或文件后缀不允许请刷新重试"
                            });
                        }
                    })
                },
                function (value) {},{confirmText:"确定",cancelText:"取消"});
        }else {
            mdui.snackbar({
                message: '提交文件格式不允许'
            });
        }
    });

</script>


